# 语音转文字功能 TODO List

## 项目概述
为 BottomInputButton 组件添加语音转文字功能，实现录音和语音识别的完整流程。

## 任务列表

### 🎯 阶段 1: 语音录制功能 (使用 expo-audio)
- [x] **环境检查**: 确认项目已安装 expo-audio (版本: ~0.4.9) ✅
- [x] **权限配置**: 
  - [x] 配置 app.json 中的音频录制权限 (android.permissions.RECORD_AUDIO, ios NSMicrophoneUsageDescription) ✅
  - [x] 在组件中添加权限请求逻辑 ✅
- [x] **录音核心功能**:
  - [x] 导入和配置 expo-audio 录音相关 hooks 和模块 ✅
  - [x] 实现录音开始/停止逻辑 (替换当前的模拟音量波动) ✅
  - [x] 获取实际的音频级别数据用于波形显示 ✅
  - [x] 处理录音文件的临时存储 ✅
- [x] **错误处理**:
  - [x] 处理权限拒绝情况 ✅
  - [x] 处理录音设备不可用情况 ✅
  - [x] 添加用户友好的错误提示 ✅

### 🎯 阶段 2: 语音识别 API 集成 (百度语音识别)
- [x] **API 配置**:
  - [x] 研究百度语音识别 API 文档 (https://cloud.baidu.com/doc/SPEECH/s/4lbxdz34z) ✅
  - [x] 创建 API 配置文件存储认证信息 ✅
  - [ ] 创建百度智能云账号并获取 API Key 和 Secret Key (需用户手动配置)
- [x] **Token 获取**:
  - [x] 实现 Access Token 获取功能 ✅
  - [x] 添加 Token 缓存和自动刷新机制 ✅
- [x] **音频格式处理**:
  - [x] 确保录音格式符合百度 API 要求 (支持 PCM, WAV, AMR 等) ✅
  - [x] 添加音频格式转换功能 (Base64编码) ✅
- [x] **API 调用**:
  - [x] 实现语音识别 API 调用函数 ✅
  - [x] 处理 API 响应和错误情况 ✅
  - [x] 添加网络请求超时和重试机制 ✅

### 🎯 阶段 3: 组件功能整合
- [x] **状态管理**:
  - [x] 添加录音状态: 'idle' | 'recording' | 'processing' | 'completed' | 'error' ✅
  - [x] 添加识别结果状态管理 ✅
  - [x] 添加加载状态指示器 ✅
- [x] **用户交互优化**:
  - [x] 录音过程中显示实际音频波形 ✅
  - [x] 录音完成后显示 "正在识别..." 状态 ✅
  - [x] 识别完成后自动发送消息 ✅
  - [ ] 添加录音取消功能 (滑动取消等) - 基础版本已实现
- [x] **视觉反馈**:
  - [x] 录音时的动画效果 (已有基础，已连接真实录音) ✅
  - [x] 处理中的加载动画 ✅
  - [x] 错误状态的视觉提示 ✅

### 🎯 阶段 4: 工具函数和类型定义
- [x] **创建工具文件**:
  - [x] `utils/audioRecording.ts` - 录音相关工具函数 ✅
  - [x] `utils/speechRecognition.ts` - 语音识别 API 封装 ✅
  - [x] `utils/speechTypes.ts` - 类型定义 ✅
  - [x] `utils/speechConfig.ts` - 配置管理 ✅
- [x] **类型定义**:
  - [x] 录音状态和配置的 TypeScript 类型 ✅
  - [x] API 响应的类型定义 ✅
  - [x] 错误处理的类型定义 ✅

### 🎯 阶段 5: 性能优化和测试
- [ ] **性能优化**:
  - [ ] 优化录音资源的释放
  - [ ] 添加音频文件的清理机制
  - [ ] 优化 API 调用频率
- [ ] **测试和调试**:
  - [ ] 在不同设备上测试录音功能
  - [ ] 测试网络异常情况的处理
  - [ ] 测试权限拒绝的用户体验
  - [ ] 添加开发模式的调试日志

### 🎯 阶段 6: 可选增强功能
- [ ] **高级功能**:
  - [ ] 支持语言选择 (中文/英文等)
  - [ ] 录音质量设置选项
  - [ ] 语音识别结果的置信度显示
  - [ ] 离线语音识别备选方案
- [ ] **用户体验**:
  - [ ] 添加触觉反馈 (Haptics)
  - [ ] 声音播放提示 (录音开始/结束)
  - [ ] 支持快捷手势操作

## 技术要点

### expo-audio 主要 API 使用
```typescript
import {
  useAudioRecorder,
  AudioModule,
  RecordingPresets,
  setAudioModeAsync,
  useAudioRecorderState,
} from 'expo-audio';
```

### 百度语音识别 API 端点
- Token 获取: `https://aip.baidubce.com/oauth/2.0/token`
- 语音识别: `https://vop.baidu.com/server_api`

### 需要的权限配置
```json
// app.json
{
  "expo": {
    "android": {
      "permissions": ["android.permission.RECORD_AUDIO"]
    },
    "ios": {
      "infoPlist": {
        "NSMicrophoneUsageDescription": "This app needs access to microphone to record voice messages."
      }
    }
  }
}
```

## 实现优先级
1. **高优先级**: 基础录音功能 + 百度 API 集成 ✅ **已完成**
2. **中优先级**: 用户交互优化 + 错误处理 ✅ **已完成**
3. **低优先级**: 性能优化 + 高级功能 ⏳ **待实现**

## 预计时间
- ✅ 阶段 1-3: 核心功能实现 (2-3天) - **已完成**
- ⏳ 阶段 4-5: 优化和测试 (1-2天) - **部分完成**
- ⏳ 阶段 6: 可选增强 (根据需求) - **待实现**

## 🎉 当前状态: 核心功能已完成！

### ✅ 已实现功能
1. **录音功能**: 长按录音，松开停止，实时音量波形显示
2. **语音识别**: 使用百度API自动识别语音并转换为文字
3. **状态管理**: 完整的录音→处理→完成/错误状态流转
4. **错误处理**: 权限检查、网络异常、API错误等完善的错误处理
5. **用户界面**: 直观的状态显示和视觉反馈
6. **自动发送**: 识别成功后自动发送消息

### ⚠️ 使用前需要配置
1. **获取百度API密钥**: 在百度智能云控制台创建语音识别应用
2. **配置环境变量**: 复制 `.env.template` 为 `.env` 并填入密钥
3. **真机测试**: 语音功能需要在真实设备上测试

### 📋 下一步优化建议
1. **性能优化**: 录音文件清理、内存管理
2. **用户体验**: 滑动取消录音、更多视觉反馈
3. **功能增强**: 多语言支持、录音质量设置
4. **错误恢复**: 自动重试机制、离线提示

---
*创建时间: 2025年9月10日*
*状态: 核心功能完成 ✅*
*更新时间: 2025年9月10日*
